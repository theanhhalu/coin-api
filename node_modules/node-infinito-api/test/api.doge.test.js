const { Helper } = require('node-infinito-util');
const Assert = require('assert');
const InfinitoApi = require('../index');
const Messages = require('../lib/messages');
const ConfigTest = require('./config.test');
const util = require('util')
const chai = require("chai");
chai.should();

const opts = {
  apiKey: ConfigTest.API_KEY,
  secret: ConfigTest.SECRECT,
  baseUrl: ConfigTest.BASE_URL,
  logLevel: ConfigTest.LOG_LEVEL
};

const addresses = {
  normal: "DQ76EaSufmEjiBiNiKLXG8UZjuc4NFUDjD",
  invalid: "DQ76EaSufmEjiBiNiKLXG8UZjuc4NFUDjDun",
  lessThan_10txs: "DSQEQxXdCAUAzwYs6RwJR9vR1ZqFxwBP3K",
  moreThan_10txs: "D8SWvyAXXwHz3SmPPNeQyf9buuaXkSSyk6",
  moreThan_50txs: "D5FF8LK8k12zU33BWPVY1QBf7aedKHtis6",
  noUTXO: "DSQEQxXdCAUAzwYs6RwJR9vR1ZqFxwBP3K",
  someUTXO: "DBTvtb5zaVfN315YeazyZP6AH87vQdANFF"
};

const txIdEx = 'fe3540ada4437f390bfe836990fcd3ebb40d852706f4f3171704daedac7c59ba';
const blkIdxEx = 500000;
const blkIdEx = '93ddd24f53ec713fe6521e96ba606fa11d3b563b7e11cb8d1d9776340bc36548';
const rawtxEx = '01000000025c62b6fbdcc0980544f3110b9462bc1149292ea485d4c9e263cdfde9c6215c7b000000006a473044022042018cc0d9d8f359e621e4a055fbfc84e30b69e753cbf158271ff6200ca9380102203d4eb70cadce326e5ebc984e66676131d1dbd99b743ebc1ca679d9847a03489801210231abe244c60cb3b4d9fdad80f48b64b03e7f5f4888b4db1bb010d088134c9ae4ffffffffabea9cd49384f27b562236e987688004161c373957dbc9251a4363eb8212ecf81c0000006b4830450221008be74693cca775afed0b9ed29d7f526ede096db0b8d34a6c6f36b71f56a1df9202205c0ab40156287e6e1672dccb00206bed9273e41bdf398b505c9545b2fb42002e01210231abe244c60cb3b4d9fdad80f48b64b03e7f5f4888b4db1bb010d088134c9ae4ffffffff0220196c5d020000001976a91425510bddefdb1b42c3117fe091e36c17406899a388ac0027b929000000001976a9143cf058cb21dfe609c1fb70e829c68f1bc94ce07a88ac00000000';

var api = null;
var coinAPI = null;

describe('api.doge', async () => {

  beforeEach(async () => {
    api = new InfinitoApi(opts);
    coinAPI = api.DOGE;
  });

  describe('#getBalance(address)', async () => {

    it('Get balance first time', async () => {
      var result = await coinAPI.getBalance(addresses.normal);
      Assert.ok(result.data.balance !== undefined, 'balance must be exist');
      Assert.ok(result.data.unconfirmed_balance !== undefined, 'unconfirmed_balance must be exist');
    });

    it('Get balance with wrong api key', async () => {
      coinAPI = new InfinitoApi(Helper.merge({}, opts, { apiKey: 'wrong api key' })).DOGE;

      try {
        await coinAPI.getBalance(addresses.normal);
        Assert.fail('Should throw exception');
      } catch (err) {
        Assert.equal(err.code, 'E1001');
        Assert.equal(err.message, Messages.invalid_api_key.message);
      }
    });

    it('test dynamic ', async () => {
      let balance = await coinAPI.getBalance('getAddressInfogetAddressInfo');
      console.log('balance :', balance);

      let history = await coinAPI.getHistory(addresses.normal, 1, 2);
      console.log('history :', history);

      let utxo = await coinAPI.getUtxo(addresses.normal);
      console.log('utxo :', utxo);
    });

    it('test dynamic expired key', async () => {
      api.tokenProvider.setToken(ConfigTest.EXPRIRED_TOKEN);

      coinAPI.getBalance(addresses.normal);
      coinAPI.getHistory(addresses.normal, 1, 2);
      coinAPI.getUtxo(addresses.normal);
    });

  });

  /*************************** Add get Address info *******************************/
  describe('#getInfo(address)', async () => {

    /*Testcase: Check with valid address*/
    it('Check with valid address', async () => {
      let info = await coinAPI.getAddressInfo(addresses.normal);
      // console.log(info);
      info.should.have.property('cd');
      info.should.have.property('data');
      info.data.should.have.property('addr');
      info.data.should.have.property('balance');
      info.data.should.have.property('unconfirmed_balance');
      info.data.should.have.property('total_received');
      info.data.should.have.property('total_sent');
      info.data.should.have.property('total_tx');
    });
  });

  /************************** Add get Address history ******************************/
  describe('#getHistory(address)', async () => {

    /*Testcase: 
          Input parameter:
            addr with >10 transaction
            no offset
            no limit*/
    it('addr with >10 transaction | no offset | no limit', async () => {
      let info = await coinAPI.getHistory(addresses.moreThan_10txs);
      // console.log(util.inspect(info, false, null));
      info.should.have.property('cd');
      info.should.have.property('data');
      info.data.should.have.property('total');
      info.data.should.have.property('from');
      info.data.should.have.property('to');
      info.data.should.have.property('txs');
    });
  });

  /************************* Add get Address utxo ****************************/
  describe('#getUtxo(address)', async () => {

    /*Testcase: 
      Input parameter:
        addr with some utxo*/
    it('addr with some utxo', async () => {
      let info = await coinAPI.getUtxo(addresses.someUTXO);
      // console.log(util.inspect(info, false, null));
      info.should.have.property('cd');
      info.should.have.property('data');
      info.data.should.have.property('transactions');
    });
  });

  /************************* Add get transaction info ****************************/
  describe('#getTxInfo(txHash)', async () => {

    /*Testcase: 
      Input parameter:
        transaction ID*/
    it('transaction info', async () => {
      let info = await coinAPI.getTxInfo(txIdEx);
      // console.log(util.inspect(info, false, null));
      info.should.have.property('cd');
      info.should.have.property('data');
      info.data.should.have.property('tx_id');
      info.data.should.have.property('version');
      info.data.should.have.property('locktime');
      info.data.should.have.property('vin');
      info.data.should.have.property('vout');
    });
  });

  /************************* Add get raw transaction ****************************/
  describe('#getRawTx(txHash)', async () => {

    /*Testcase: 
      Input parameter:
        transaction ID*/
    it('raw transaction', async () => {
      let info = await coinAPI.getRawTx(txIdEx);
      // console.log(util.inspect(info, false, null));
      info.should.have.property('cd');
      info.should.have.property('data');
      info.data.should.have.property('raw_tx');
    });
  });

  /************************* Add get blockHash by blockIndex ****************************/
  describe('#getBlockHashByIndex(index)', async () => {

    /*Testcase: 
      Input parameter:
        Block Index*/
    it('blockHash by blockIndex', async () => {
      let info = await coinAPI.getBlockHashByIndex(blkIdxEx);
      // console.log(util.inspect(info, false, null));
      info.should.have.property('cd');
      info.should.have.property('data');
      info.data.should.have.property('block_id');
    });
  });

  /************************* Add get block info ****************************/
  describe('#getBlockInfo(blockId)', async () => {

    /*Testcase: 
      Input parameter:
        Block ID*/
    it('block info', async () => {
      let info = await coinAPI.getBlockInfo(blkIdEx);
      // console.log(util.inspect(info, false, null));
      info.should.have.property('cd');
      info.should.have.property('data');
      info.data.should.have.property('block_id');
      info.data.should.have.property('size');
      info.data.should.have.property('height');
      info.data.should.have.property('version');
      info.data.should.have.property('merkleroot');
      info.data.should.have.property('time');
      info.data.should.have.property('nonce');
      info.data.should.have.property('bits');
      info.data.should.have.property('difficulty');
      info.data.should.have.property('chainwork');
      info.data.should.have.property('confirmations');
      info.data.should.have.property('previous_block_hash');
      info.data.should.have.property('next_block_hash');
      info.data.should.have.property('reward');
      info.data.should.have.property('pool_info');
    });
  });

  /************************* Add get transactions in a block ****************************/
  describe('#getBlockTxs(blockId)', async () => {

    /*Testcase: 
      Input parameter:
        Block ID*/
    it('transactions in a block', async () => {
      let info = await coinAPI.getBlockTxs(blkIdEx);
      // console.log(util.inspect(info, false, null));
      info.should.have.property('cd');
      info.should.have.property('data');
      info.data.should.have.property('total');
      info.data.should.have.property('transactions');
    });
  });

  /************************* Add get raw block ****************************/
  describe('#getRawBlock(blockId)', async () => {

    /*Testcase: 
      Input parameter:
        Block ID*/
    it('raw block', async () => {
      let info = await coinAPI.getRawBlock(blkIdEx);
      // console.log(util.inspect(info, false, null));
      info.should.have.property('cd');
      info.should.have.property('data');
      info.data.should.have.property('raw_block');
    });
  });

  /************************* post Send Raw ***********************************/
  describe('#postSendRaw', async () => {

    it('send a tx', async () => {
      let res = await coinAPI.sendTransaction({rawtx: rawtxEx});
      console.log(res);
      res.should.have.property('cd');
    });
  });
});